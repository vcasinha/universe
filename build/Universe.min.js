/*! Universe 2015-02-15 */
!function(){var a=function(){};a.prototype.init=function(a){this.engine=new Engine(a),this.engine.init(),this.ctx=this.engine.ctx;var b=$("#stage");b.append(this.engine.getElement());var c=function(){this.engine.handleFullScreen(),b.off("click",c)}.bind(this);b.click(c),this.engine.handleResize(b.width(),b.height()),$(window).on("resize",function(){this.engine.handleResize(b.width(),b.height())}.bind(this))},a.prototype.start=function(){this.engine.start()},a.prototype.stop=function(){this.engine.stop()},a.prototype.togglePause=function(){this.engine.paused=!this.engine.paused},O.register("engine.application",a)}(),function(){var a=function(a,b){this.ctx=a,this.settings=O.extend({},this.default_settings,b);var c=function(a){this.update(a)}.bind(this),d=function(){a.off("component.update",c)}.bind(this);a.on("component.update",c),a.once("stop",d)};a.prototype.classes=[],a.prototype.settings_default={name:"Unnamed component",version:"0.0",paused:!1},a.prototype.update=function(){},a.prototype.shutdown=function(){},O.register("engine.component",a)}(),function(){var a=function(){window.AudioContext=window.AudioContext||window.webkitAudioContext,this.audioContext=new AudioContext};a.prototype.classes=["engine.component"],a.prototype.load=function(a){var b={onload:function(){this.set(a.name,c),this.ctx.trigger("audio.loaded."+a.name,a)}.bind(this)};b.urls="string"==typeof a.location?[a.location]:a.location;var c=new Howl(b)},O.register("component.audio.howl",a)}(),function(){var a=function(){this.statesLogic=[],this.bootState=null,this.current_state=null,this.states={},this.paused=!1};a.prototype.classes=["engine.component"],O.register("component.data",a)}(),function(){var a=function(){this.queue=[]};a.prototype.classes=["engine.component"],a.prototype.queueList=function(a){a.forEach(function(a){this.queueAsset(a)}.bind(this))},a.prototype.queueAsset=function(a){for(var b in this.queue)if(this.queue[b].name==a.name)return this.queue[b]=a,this;return a.type=a.type.toLowerCase(),this.queue.push(a),this},a.prototype.load=function(a,b){return this.queueList(a),this.processQueue(),"function"==typeof b&&this.ctx.once("assets.loaded",b),this},a.prototype.processQueue=function(){return this.queue.forEach(function(a){switch(this.ctx.once(a.type+".loaded."+a.name,function(a){this.removeFromQueue(a),0===this.queue.length&&this.ctx.trigger("assets.loaded")}.bind(this)),a.type){case"image":this.handlePIXI(a);break;case"audio":this.handleAudio(a);break;default:throw"loader.load.invalid asset type "+a.type}}.bind(this)),this},a.prototype.handlePIXI=function(a){var b={image:PIXI.ImageLoader,json:PIXI.JsonLoader,atlas:PIXI.AtlasLoader,anim:PIXI.SpineLoader,font:PIXI.BitmapFontLoader},c=b[a.type];if(!c)throw new Error(a.type+" is an unsupported file type");var d=new c(a.location,!1);d.on("loaded",function(){this.ctx.renderer.assets.set(a.name,a),this.ctx.trigger(a.type+".loaded."+a.name,a)}.bind(this)),d.load()},a.prototype.handleAudio=function(a){this.ctx.audio.load(a)},a.prototype.removeFromQueue=function(a){return this.queue.splice(this.queue.indexOf(a),1),this},O.register("component.loader",a)}(),function(){var a=function(a,b){this.details=b=b||{},this.definition=new b2BodyDef;for(var c in this.definitionDefaults)this.definition[c]=b[c]||this.definitionDefaults[c];this.definition.position=new b2Vec2(b.x||0,b.y||0),this.definition.linearVelocity=new b2Vec2(b.vx||0,b.vy||0),this.definition.userData=b.userdata,this.definition.type="static"==b.type?b2Body.b2_staticBody:b2Body.b2_dynamicBody,this.body=a.CreateBody(this.definition),this.fixtureDef=new b2FixtureDef;for(var d in this.fixtureDefaults)this.fixtureDef[d]=b[d]||this.fixtureDefaults[d];switch(b.shape=b.shape||this.defaults.shape,b.shape){case"circle":b.radius=b.radius||this.defaults.radius,this.fixtureDef.shape=new b2CircleShape(b.radius);break;case"polygon":this.fixtureDef.shape=new b2PolygonShape,this.fixtureDef.shape.SetAsArray(b.points,b.points.length);break;case"box":default:console.log("box",b),b.width=b.width||this.defaults.width,b.height=b.height||this.defaults.height,this.fixtureDef.shape=new b2PolygonShape,this.fixtureDef.shape.SetAsBox(b.width,b.height)}this.body.CreateFixture(this.fixtureDef)};a.prototype.defaults={shape:"box",width:5,height:5,radius:2.5},a.prototype.fixtureDefaults={density:2,friction:1,restitution:.2},a.prototype.definitionDefaults={active:!0,allowSleep:!0,angle:0,angularVelocity:0,awake:!0,bullet:!1,fixedRotation:!1},O.register("physics.body.box2d",a)}(),function(){var a=function(){var a=function(){this.dtRemaining=0,this.stepAmount=this.settings.stepAmount||1/60,this.scale=this.settings.scale||10;var a=new b2Vec2(this.settings.gravity.x||0,this.settings.gravity.y||10);this.world=new b2World(a,!0)}.bind(this),b=function(){this.ctx.off("update",c)}.bind(this),c=function(a){this.update(a)}.bind(this);this.ctx.once("init",a),this.ctx.on("update",c),this.ctx.once("stop",b)};a.prototype.classes=["engine.component","o.events"],a.prototype.update=function(a){for(this.dtRemaining+=a;this.dtRemaining>this.stepAmount;)this.dtRemaining-=this.stepAmount,this.world.Step(this.stepAmount,8,3);this.trigger("physics.update")},a.prototype.debug=function(){this.debugDraw=new b2DebugDraw;var a=this.ctx.renderer.getElement().getContext("2d");console.log("physics.debug.canvas",a),this.debugDraw.SetSprite(a),this.debugDraw.SetDrawScale(10),this.debugDraw.SetFillAlpha(.5),this.debugDraw.SetLineThickness(1),this.debugDraw.SetFlags(b2DebugDraw.e_shapeBit|b2DebugDraw.e_jointBit),this.world.SetDebugDraw(this.debugDraw)},a.prototype.getGravity=function(){return this.world.GetGravity()},a.prototype.handleContact=function(a){var b=Box2D.Dynamics.b2ContactListener,c=new b;O.extend(c,a),this.world.SetContactListener(c)},a.prototype.createBody=function(a){return a.x&&(a.x/=this.scale),a.y&&(a.y/=this.scale),a.width&&(a.width/=this.scale),a.height&&(a.height/=this.scale),a.radius&&(a.radius/=this.scale),O.instance("physics.body.box2d",this.world,a)},a.prototype.attachBody=function(a,b){a.body=this.createBody(b).body,a.body.SetUserData(a),this.on("physics.update",function(){var b=a.body.GetPosition(),c=a.body.GetAngle();a.position.x=b.x*this.scale,a.position.y=b.y*this.scale,a.rotation=c}.bind(this))},O.register("component.physics.box2d",a)}(),function(a){a.Point.prototype.mulScalar=function(a){this.x*=a,this.y*=a},a.Point.prototype.from=function(a){this.set(a.x,a.y)},a.Point.prototype.add=function(a){this.set(this.x+a.x,this.y+a.y)},a.Point.prototype.sub=function(a){this.set(this.x-a.x,this.y-a.y)};var b=function(b,c){console.log("renderer.pixi.start",this.settings);var d=function(){this.renderer.render(this.stage)}.bind(this),e=function(){this.stage=new a.Stage(c.background||0,c.interactive),this.renderer=a.autoDetectRenderer(c.width,c.height,c.renderer)}.bind(this),f=function(){b.off("update",d)}.bind(this);b.once("init",e),b.on("update",d),b.once("stop",f),this.assets=new O};b.prototype.classes=["engine.component"],b.prototype.getElement=function(){return this.renderer.view},b.prototype.resize=function(a,b){this.width=a,this.height=b,this.renderer&&this.renderer.resize(this.width,this.height)},b.prototype.layer=function(){return new a.DisplayObjectContainer},b.prototype.createGroup=function(){return new a.DisplayObjectContainer},b.prototype.getTexture=function(b){var c=this.assets.get(b);if(void 0===c)throw"Asset not loaded "+b;return a.Texture.fromImage(c.location)},b.prototype.getAnimationTextures=function(b){for(var c=b.width,d=b.height,e=[],f=b.frameCount||0,g=this.getTexture(b.name),h=0,i=b.y||0;i<g.height;i+=d)for(var j=b.x||0;j<g.width;j+=c)if(!(j+c>g.width||i+d>g.width)){h++;var k=new a.Rectangle(j,i,c,d),l=k.clone(),m=null,n=new a.Texture(g,k,l,m);if(e.push(n),f&&f==h)break}return e},b.prototype.getAnimation=function(b){var c=this.getAnimationTextures(b),d=new a.MovieClip(c);return d},b.prototype.getSprite=function(b){var c;return void 0!==b&&(c=this.getTexture(b)),new a.Sprite(c)},b.prototype.requestFullScreen=function(){this.renderer.view.webkitRequestFullScreen?this.renderer.view.webkitRequestFullScreen():this.renderer.view.mozRequestFullScreen()},b.prototype.add=function(a){return this.stage.addChild(a)},b.prototype.remove=function(a){return this.stage.removeChild(a)},O.register("component.renderer.pixi",b)}(PIXI),function(){var a=function(){console.log("component.construct"),this.objects={};var a=this.settings.step||1/60,b=0,c=(new Date).getTime(),d=function(d){return b>d?(b-=d,!1):(time_now=(new Date).getTime(),time_delta=(time_now-c)/1e3,c=time_now,this.trigger("update",time_delta),this.trigger("addon.update",time_delta),this.update(time_delta/1e3),void(b=a))}.bind(this),e=function(){this.start(),this.reset()}.bind(this),f=function(){this.stop(),this.ctx.off("update",d)}.bind(this);this.ctx.once("init",e),this.ctx.once("stop",f),this.ctx.on("update",d)};a.prototype.classes=["engine.component","o.events"],a.prototype.width=function(){return this.ctx.renderer.width},a.prototype.height=function(){return this.ctx.renderer.height},a.prototype.start=function(){this.container=this.ctx.renderer.layer(),this.ctx.renderer.add(this.container)},a.prototype.stop=function(){for(var a in this.objects)this.objects[a].stop(),delete this.objects[i]},a.prototype.reset=function(){this.stop(),this.entities={}},a.prototype.get=function(a){return this.objects[a]},a.prototype.createAdd=function(a){var b={instance:"stage.object"},c=O.extend({},b,a);console.log("stage.createAdd",c);var d=O.instance(c.instance,this,c);return this.add(d),d},a.prototype.add=function(a){var b=a.getID();if(void 0===b)throw console.warn("stage.add Object ID is undefined",a),"Object ID is undefined";return console.log("stage.add",b,this.objects),this.objects[b]=a,this},a.prototype.remove=function(a){"object"==typeof a&&(a=b.getID());var b=this.get(a);return b&&(b.stop(),delete this.objects[a]),this},a.prototype.update=function(){},O.register("component.stage",a)}(),function(){var a=function(){console.log("component.state.construct"),this.statesLogic=[],this.bootState=null,this.current_state=null,this.states={},this.paused=!1;var a=this.settings.step||1/30,b=0,c=function(c){return b>c?(b-=c,!1):(this.update(c),void(b=a))}.bind(this),d=function(){console.log("component.state.init",this.settings);for(var a in this.settings.states){var b=this.settings.states[a];this.addState(b,"sm."+b)}}.bind(this),e=function(){this.ctx.off("update",c)}.bind(this),f=function(){this.start(this.settings.boot||"boot")}.bind(this);this.ctx.once("init",d),this.ctx.once("start",f),this.ctx.on("update",c),this.ctx.once("stop",e)};a.prototype.classes=["engine.component"],a.prototype.changeTo=function(a){this.stop(),this.start(a)},a.prototype.addState=function(a,b){this.states[a]=b},a.prototype.stop=function(){return this.currentState&&(console.log("state.stop",this.currentState.name),this.currentState.instance.stop()),this},a.prototype.start=function(a){this.currentState&&this.stop(),console.log("state.start",a);var b=this.states[a],c=O.instance(b,this.ctx);if(void 0===c)throw"Undefined state "+a;this.currentState={name:a,instance:c},this.currentState.instance.start()},a.prototype.update=function(a){this.currentState&&this.currentState.instance.update(a)},O.register("component.state",a)}(),function(){var a=function(a){this.settings=a,this.components={};for(var b in a.components)this.loadComponent(b,a.components[b])};a.prototype.classes=["o.events"],a.prototype.loadComponent=function(a,b){var c=this.settings[a]||{},d=O.instance(b,this,c);return this.components[a]=this[a]=d,d},O.register("engine.context",a)}(O),function(){var a=function(a,b){this.ctx=a,this.settings=O.extend({},this.default_settings,b);var c=function(a){this.update(a)}.bind(this),d=function(){a.off("component.update",c)}.bind(this);a.on("component.update",c),a.once("stop",d)};a.prototype.classes=[],a.prototype.settings_default={name:"Unnamed component",version:"0.0",paused:!1},a.prototype.update=function(){},a.prototype.shutdown=function(){},O.register("engine.component",a)}(),function(){var a=function(a){this.settings=a,this.components={};for(var b in a.components)this.loadComponent(b,a.components[b])};a.prototype.classes=["o.events"],a.prototype.loadComponent=function(a,b){var c=this.settings[a]||{},d=O.instance(b,this,c);return this.components[a]=this[a]=d,d},O.register("engine.context",a)}(O),function(){var a=function(a){this.isRunning=!1,this.isPaused=!1,this.components=[],this.settings=a=O.extend(!0,{},this.settings_default,a),console.log("engine.construct",a),this.ctx=O.instance("engine.context",a),console.log("engine.construct Initialize context");var b=time_current=(new Date).getTime(),c=0,d=function(){requestAnimationFrame(d),this.isRunning&&(time_current=(new Date).getTime(),c=(time_current-b)/1e3,this.ctx.trigger("update",c,time_current),b=time_current)}.bind(this),e=function(){this.ctx.off("start",f),this.ctx.off("pause",g),this.ctx.off("stop",e)}.bind(this),f=function(){this.isRunning=!0}.bind(this),g=function(){this.isRunning=!1}.bind(this);this.ctx.on("start",f),this.ctx.on("pause",g),console.log("engine.construct Setup animation frame"),requestAnimationFrame(d)};a.prototype.classes=["o.events"],a.prototype.settings_default={components:{renderer:"component.renderer.pixi",audio:"component.audio.howl",physics:"component.physics.box2dweb",stage:"component.stage",loader:"component.loader",state:"component.state",data:"component.data"},renderer:{}},a.prototype.loadComponent=function(a,b){return this.ctx.loadComponent(a,b),this},a.prototype.init=function(){console.log("engine.init"),this.ctx.trigger("init")},a.prototype.handleFullScreen=function(){return this.ctx.renderer.requestFullScreen.bind(this.ctx.renderer)},a.prototype.handleResize=function(a,b){this.ctx.renderer.resize(a,b)},a.prototype.getElement=function(){return this.ctx.renderer.getElement()},a.prototype.addState=function(a,b){return this.ctx.state.addState(a,b),this},a.prototype.start=function(){console.log("engine.start"),this.ctx.trigger("start")},a.prototype.stop=function(){return console.log("engine.stop"),this.ctx.trigger("stop"),this},a.prototype.update=function(){requestAnimationFrame(this.updateCallback),this.timeCurrent=(new Date).getTime(),this.timeDelta=(this.timeCurrent-this.timePrevious)/1e3,this.paused||(this.ctx.trigger("update",this.timeDelta),this.ctx.trigger("update.renderer")),this.timePrevious=this.timeCurrent},O.register("engine",a),window.Engine=a}(),function(){var a=function(a){this.stage=a.stage,this.stage.reset()};a.prototype.classes=["engine.component"],a.prototype.update=function(){},O.register("engine.state",a)}(Engine),function(){var a=function(){};a.prototype.init=function(a){this.engine=new Engine(a),this.engine.init(),this.ctx=this.engine.ctx;var b=$("#stage");b.append(this.engine.getElement());var c=function(){this.engine.handleFullScreen(),b.off("click",c)}.bind(this);b.click(c),this.engine.handleResize(b.width(),b.height()),$(window).on("resize",function(){this.engine.handleResize(b.width(),b.height())}.bind(this))},a.prototype.start=function(){this.engine.start()},a.prototype.stop=function(){this.engine.stop()},a.prototype.togglePause=function(){this.engine.paused=!this.engine.paused},O.register("engine.application",a)}(),function(){var a=function(){};a.prototype.classes=["stage.object"],a.prototype.attachBody=function(a){a.x=entity.position.x,a.y=entity.position.y,this.ctx.physics.attachBody(entity,a)},O.register("addon.physics",a)}(),function(){var a=function(a){this.sprite=this.settings.sprite,this.animations={},this.currentAnimation=null;var b=0,c=function(a){return b>a?(b-=a,!1):void(this.currentAnimation&&(this.currentAnimation.currentFrame++,this.currentAnimation.currentFrame>this.currentAnimation.endFrame&&(this.currentAnimation.currentFrame=this.currentAnimation.startFrame),b=1/this.currentAnimation.fps,this.sprite.setFrame(this.currentAnimation.currentFrame)))}.bind(this),d=function(){this.off(c)}.bind(this);a.on("addon.update",c),a.once("stop",d),this.sprite.setFrame(0)};a.prototype.classes=["stage.object"],a.prototype.add=function(a){if("object"!=typeof a)throw console.error("animation.add Invalida animation argument",a),"";a.startFrame=this.sprite.frames.length;var b=this.sprite.loadAnimation(a);a.endFrame=a.startFrame+b.length,a.currentFrame=a.startFrame,this.animations[a.name]=a},a.prototype.play=function(a){if("string"!=typeof a)throw console.error("animation.play Invalid animation name argument",a),"";this.currentAnimation=this.animations[a],this.currentAnimation.currentFrame=this.currentAnimation.startFrame,console.log("animation.play",this.currentAnimation)},O.register("addon.animation",a)}(),function(){var a=function(a,b){this.frames=[],this.renderer=this.ctx.renderer,this.currentFrame=null,this.stage=a,this.ctx=a.ctx;var c={x:0,y:0,anchor:{x:.5,y:.5}};this.settings=O.extend({},c,b),this.sprite=this.ctx.renderer.getSprite(),this.ctx.renderer.add(this.sprite),this.sprite.anchor.set(this.settings.anchor.x,this.settings.anchor.y),this.sprite.position.set(this.settings.x,this.settings.y),this.position=this.sprite.position,this.scale=this.sprite.scale,this.sprite.interactive=!0,this.sprite.buttonMode=!0};a.prototype.classes=["stage.object"],a.prototype.loadFrame=function(a,b){b=b||this.frames.length;var c=this.renderer.getTexture(a);return this.frames[b]=c,this.frameCurrent||this.setFrame(0),this},a.prototype.nextFrame=function(){this.setFrame(this.currentFrame+1)},a.prototype.setFrame=function(a){return 0===this.frames.length?this:(a>this.frames.length-1&&(a=0),0>a&&(a=this.frames.length-1),this.currentFrame=a,this.sprite.setTexture(this.frames[this.currentFrame]),this)},a.prototype.loadAnimation=function(a){var b=this.renderer.getAnimationTextures(a);console.log("sprite.loadAnimation",b.length);for(var c in b)this.frames.push(b[c]);return b},O.register("addon.sprite",a)}(),function(){function a(){return parseInt((new Date).getTime()).toString(16)}var b=function(b,c){this.stage=b,this.ctx=b.ctx;var d={id:a(),x:0,y:0,anchor:{x:.5,y:.5}};this.settings=O.extend({},d,c);var e=function(){this.update()}.bind(this),f=function(){this.ctx.off("update",e)}.bind(this);this.ctx.on("update",e),this.ctx.once("stop",f)};b.prototype.classes=["o.events"],b.prototype.update=function(){},b.prototype.getID=function(){return this.settings.id},O.register("stage.object",b)}(),function(){var a=function(){this.queue=[]};a.prototype.classes=["engine.component"],a.prototype.queueList=function(a){a.forEach(function(a){this.queueAsset(a)}.bind(this))},a.prototype.queueAsset=function(a){for(var b in this.queue)if(this.queue[b].name==a.name)return this.queue[b]=a,this;return a.type=a.type.toLowerCase(),this.queue.push(a),this},a.prototype.load=function(a,b){return this.queueList(a),this.processQueue(),"function"==typeof b&&this.ctx.once("assets.loaded",b),this},a.prototype.processQueue=function(){return this.queue.forEach(function(a){switch(this.ctx.once(a.type+".loaded."+a.name,function(a){this.removeFromQueue(a),0===this.queue.length&&this.ctx.trigger("assets.loaded")}.bind(this)),a.type){case"image":this.handlePIXI(a);break;case"audio":this.handleAudio(a);break;default:throw"loader.load.invalid asset type "+a.type}}.bind(this)),this},a.prototype.handlePIXI=function(a){var b={image:PIXI.ImageLoader,json:PIXI.JsonLoader,atlas:PIXI.AtlasLoader,anim:PIXI.SpineLoader,font:PIXI.BitmapFontLoader},c=b[a.type];if(!c)throw new Error(a.type+" is an unsupported file type");var d=new c(a.location,!1);d.on("loaded",function(){this.ctx.renderer.assets.set(a.name,a),this.ctx.trigger(a.type+".loaded."+a.name,a)}.bind(this)),d.load()},a.prototype.handleAudio=function(a){this.ctx.audio.load(a)},a.prototype.removeFromQueue=function(a){return this.queue.splice(this.queue.indexOf(a),1),this},O.register("component.loader",a)}(),function(a){a.Point.prototype.mulScalar=function(a){this.x*=a,this.y*=a},a.Point.prototype.from=function(a){this.set(a.x,a.y)},a.Point.prototype.add=function(a){this.set(this.x+a.x,this.y+a.y)},a.Point.prototype.sub=function(a){this.set(this.x-a.x,this.y-a.y)};var b=function(b,c){console.log("renderer.pixi.start",this.settings);var d=function(){this.renderer.render(this.stage)}.bind(this),e=function(){this.stage=new a.Stage(c.background||0,c.interactive),this.renderer=a.autoDetectRenderer(c.width,c.height,c.renderer)}.bind(this),f=function(){b.off("update",d)}.bind(this);b.once("init",e),b.on("update",d),b.once("stop",f),this.assets=new O};b.prototype.classes=["engine.component"],b.prototype.getElement=function(){return this.renderer.view},b.prototype.resize=function(a,b){this.width=a,this.height=b,this.renderer&&this.renderer.resize(this.width,this.height)},b.prototype.layer=function(){return new a.DisplayObjectContainer},b.prototype.createGroup=function(){return new a.DisplayObjectContainer},b.prototype.getTexture=function(b){var c=this.assets.get(b);if(void 0===c)throw"Asset not loaded "+b;return a.Texture.fromImage(c.location)},b.prototype.getAnimationTextures=function(b){for(var c=b.width,d=b.height,e=[],f=b.frameCount||0,g=this.getTexture(b.name),h=0,i=b.y||0;i<g.height;i+=d)for(var j=b.x||0;j<g.width;j+=c)if(!(j+c>g.width||i+d>g.width)){h++;var k=new a.Rectangle(j,i,c,d),l=k.clone(),m=null,n=new a.Texture(g,k,l,m);if(e.push(n),f&&f==h)break}return e},b.prototype.getAnimation=function(b){var c=this.getAnimationTextures(b),d=new a.MovieClip(c);return d},b.prototype.getSprite=function(b){var c;return void 0!==b&&(c=this.getTexture(b)),new a.Sprite(c)},b.prototype.requestFullScreen=function(){this.renderer.view.webkitRequestFullScreen?this.renderer.view.webkitRequestFullScreen():this.renderer.view.mozRequestFullScreen()},b.prototype.add=function(a){return this.stage.addChild(a)},b.prototype.remove=function(a){return this.stage.removeChild(a)},O.register("component.renderer.pixi",b)}(PIXI),function(){var a=function(){console.log("component.state.construct"),this.statesLogic=[],this.bootState=null,this.current_state=null,this.states={},this.paused=!1;var a=this.settings.step||1/30,b=0,c=function(c){return b>c?(b-=c,!1):(this.update(c),void(b=a))}.bind(this),d=function(){console.log("component.state.init",this.settings);for(var a in this.settings.states){var b=this.settings.states[a];this.addState(b,"sm."+b)}}.bind(this),e=function(){this.ctx.off("update",c)}.bind(this),f=function(){this.start(this.settings.boot||"boot")}.bind(this);this.ctx.once("init",d),this.ctx.once("start",f),this.ctx.on("update",c),this.ctx.once("stop",e)};a.prototype.classes=["engine.component"],a.prototype.changeTo=function(a){this.stop(),this.start(a)},a.prototype.addState=function(a,b){this.states[a]=b},a.prototype.stop=function(){return this.currentState&&(console.log("state.stop",this.currentState.name),this.currentState.instance.stop()),this},a.prototype.start=function(a){this.currentState&&this.stop(),console.log("state.start",a);var b=this.states[a],c=O.instance(b,this.ctx);if(void 0===c)throw"Undefined state "+a;this.currentState={name:a,instance:c},this.currentState.instance.start()},a.prototype.update=function(a){this.currentState&&this.currentState.instance.update(a)},O.register("component.state",a)}(),function(){var a=function(a,b){this.details=b=b||{},this.definition=new b2BodyDef;for(var c in this.definitionDefaults)this.definition[c]=b[c]||this.definitionDefaults[c];this.definition.position=new b2Vec2(b.x||0,b.y||0),this.definition.linearVelocity=new b2Vec2(b.vx||0,b.vy||0),this.definition.userData=b.userdata,this.definition.type="static"==b.type?b2Body.b2_staticBody:b2Body.b2_dynamicBody,this.body=a.CreateBody(this.definition),this.fixtureDef=new b2FixtureDef;for(var d in this.fixtureDefaults)this.fixtureDef[d]=b[d]||this.fixtureDefaults[d];switch(b.shape=b.shape||this.defaults.shape,b.shape){case"circle":b.radius=b.radius||this.defaults.radius,this.fixtureDef.shape=new b2CircleShape(b.radius);break;case"polygon":this.fixtureDef.shape=new b2PolygonShape,this.fixtureDef.shape.SetAsArray(b.points,b.points.length);break;case"box":default:console.log("box",b),b.width=b.width||this.defaults.width,b.height=b.height||this.defaults.height,this.fixtureDef.shape=new b2PolygonShape,this.fixtureDef.shape.SetAsBox(b.width,b.height)}this.body.CreateFixture(this.fixtureDef)};a.prototype.defaults={shape:"box",width:5,height:5,radius:2.5},a.prototype.fixtureDefaults={density:2,friction:1,restitution:.2},a.prototype.definitionDefaults={active:!0,allowSleep:!0,angle:0,angularVelocity:0,awake:!0,bullet:!1,fixedRotation:!1},O.register("physics.body.box2d",a)}(),function(){var a=function(){var a=function(){this.dtRemaining=0,this.stepAmount=this.settings.stepAmount||1/60,this.scale=this.settings.scale||10;var a=new b2Vec2(this.settings.gravity.x||0,this.settings.gravity.y||10);this.world=new b2World(a,!0)}.bind(this),b=function(){this.ctx.off("update",c)}.bind(this),c=function(a){this.update(a)}.bind(this);this.ctx.once("init",a),this.ctx.on("update",c),this.ctx.once("stop",b)};a.prototype.classes=["engine.component","o.events"],a.prototype.update=function(a){for(this.dtRemaining+=a;this.dtRemaining>this.stepAmount;)this.dtRemaining-=this.stepAmount,this.world.Step(this.stepAmount,8,3);this.trigger("physics.update")},a.prototype.debug=function(){this.debugDraw=new b2DebugDraw;var a=this.ctx.renderer.getElement().getContext("2d");console.log("physics.debug.canvas",a),this.debugDraw.SetSprite(a),this.debugDraw.SetDrawScale(10),this.debugDraw.SetFillAlpha(.5),this.debugDraw.SetLineThickness(1),this.debugDraw.SetFlags(b2DebugDraw.e_shapeBit|b2DebugDraw.e_jointBit),this.world.SetDebugDraw(this.debugDraw)},a.prototype.getGravity=function(){return this.world.GetGravity()},a.prototype.handleContact=function(a){var b=Box2D.Dynamics.b2ContactListener,c=new b;O.extend(c,a),this.world.SetContactListener(c)},a.prototype.createBody=function(a){return a.x&&(a.x/=this.scale),a.y&&(a.y/=this.scale),a.width&&(a.width/=this.scale),a.height&&(a.height/=this.scale),a.radius&&(a.radius/=this.scale),O.instance("physics.body.box2d",this.world,a)},a.prototype.attachBody=function(a,b){a.body=this.createBody(b).body,a.body.SetUserData(a),this.on("physics.update",function(){var b=a.body.GetPosition(),c=a.body.GetAngle();a.position.x=b.x*this.scale,a.position.y=b.y*this.scale,a.rotation=c}.bind(this))},O.register("component.physics.box2d",a)}(),function(){var a=function(){this.statesLogic=[],this.bootState=null,this.current_state=null,this.states={},this.paused=!1};a.prototype.classes=["engine.component"],O.register("component.data",a)}(),function(){var a=function(){window.AudioContext=window.AudioContext||window.webkitAudioContext,this.audioContext=new AudioContext};a.prototype.classes=["engine.component"],a.prototype.load=function(a){var b={onload:function(){this.set(a.name,c),this.ctx.trigger("audio.loaded."+a.name,a)}.bind(this)};b.urls="string"==typeof a.location?[a.location]:a.location;var c=new Howl(b)},O.register("component.audio.howl",a)}(),function(){var a=function(){console.log("component.construct"),this.objects={};var a=this.settings.step||1/60,b=0,c=(new Date).getTime(),d=function(d){return b>d?(b-=d,!1):(time_now=(new Date).getTime(),time_delta=(time_now-c)/1e3,c=time_now,this.trigger("update",time_delta),this.trigger("addon.update",time_delta),this.update(time_delta/1e3),void(b=a))}.bind(this),e=function(){this.start(),this.reset()}.bind(this),f=function(){this.stop(),this.ctx.off("update",d)}.bind(this);this.ctx.once("init",e),this.ctx.once("stop",f),this.ctx.on("update",d)};a.prototype.classes=["engine.component","o.events"],a.prototype.width=function(){return this.ctx.renderer.width},a.prototype.height=function(){return this.ctx.renderer.height},a.prototype.start=function(){this.container=this.ctx.renderer.layer(),this.ctx.renderer.add(this.container)},a.prototype.stop=function(){for(var a in this.objects)this.objects[a].stop(),delete this.objects[i]},a.prototype.reset=function(){this.stop(),this.entities={}},a.prototype.get=function(a){return this.objects[a]},a.prototype.createAdd=function(a){var b={instance:"stage.object"},c=O.extend({},b,a);console.log("stage.createAdd",c);var d=O.instance(c.instance,this,c);return this.add(d),d},a.prototype.add=function(a){var b=a.getID();if(void 0===b)throw console.warn("stage.add Object ID is undefined",a),"Object ID is undefined";return console.log("stage.add",b,this.objects),this.objects[b]=a,this},a.prototype.remove=function(a){"object"==typeof a&&(a=b.getID());var b=this.get(a);return b&&(b.stop(),delete this.objects[a]),this},a.prototype.update=function(){},O.register("component.stage",a)}(),function(){var a=function(a){this.isRunning=!1,this.isPaused=!1,this.components=[],this.settings=a=O.extend(!0,{},this.settings_default,a),console.log("engine.construct",a),this.ctx=O.instance("engine.context",a),console.log("engine.construct Initialize context");var b=time_current=(new Date).getTime(),c=0,d=function(){requestAnimationFrame(d),this.isRunning&&(time_current=(new Date).getTime(),c=(time_current-b)/1e3,this.ctx.trigger("update",c,time_current),b=time_current)}.bind(this),e=function(){this.ctx.off("start",f),this.ctx.off("pause",g),this.ctx.off("stop",e)}.bind(this),f=function(){this.isRunning=!0}.bind(this),g=function(){this.isRunning=!1}.bind(this);this.ctx.on("start",f),this.ctx.on("pause",g),console.log("engine.construct Setup animation frame"),requestAnimationFrame(d)};a.prototype.classes=["o.events"],a.prototype.settings_default={components:{renderer:"component.renderer.pixi",audio:"component.audio.howl",physics:"component.physics.box2dweb",stage:"component.stage",loader:"component.loader",state:"component.state",data:"component.data"},renderer:{}},a.prototype.loadComponent=function(a,b){return this.ctx.loadComponent(a,b),this},a.prototype.init=function(){console.log("engine.init"),this.ctx.trigger("init")},a.prototype.handleFullScreen=function(){return this.ctx.renderer.requestFullScreen.bind(this.ctx.renderer)},a.prototype.handleResize=function(a,b){this.ctx.renderer.resize(a,b)},a.prototype.getElement=function(){return this.ctx.renderer.getElement()},a.prototype.addState=function(a,b){return this.ctx.state.addState(a,b),this},a.prototype.start=function(){console.log("engine.start"),this.ctx.trigger("start")},a.prototype.stop=function(){return console.log("engine.stop"),this.ctx.trigger("stop"),this},a.prototype.update=function(){requestAnimationFrame(this.updateCallback),this.timeCurrent=(new Date).getTime(),this.timeDelta=(this.timeCurrent-this.timePrevious)/1e3,this.paused||(this.ctx.trigger("update",this.timeDelta),this.ctx.trigger("update.renderer")),this.timePrevious=this.timeCurrent},O.register("engine",a),window.Engine=a}(),function(){var a=function(a){this.sprite=this.settings.sprite,this.animations={},this.currentAnimation=null;var b=0,c=function(a){return b>a?(b-=a,!1):void(this.currentAnimation&&(this.currentAnimation.currentFrame++,this.currentAnimation.currentFrame>this.currentAnimation.endFrame&&(this.currentAnimation.currentFrame=this.currentAnimation.startFrame),b=1/this.currentAnimation.fps,this.sprite.setFrame(this.currentAnimation.currentFrame)))}.bind(this),d=function(){this.off(c)}.bind(this);a.on("addon.update",c),a.once("stop",d),this.sprite.setFrame(0)};a.prototype.classes=["stage.object"],a.prototype.add=function(a){if("object"!=typeof a)throw console.error("animation.add Invalida animation argument",a),"";a.startFrame=this.sprite.frames.length;var b=this.sprite.loadAnimation(a);a.endFrame=a.startFrame+b.length,a.currentFrame=a.startFrame,this.animations[a.name]=a},a.prototype.play=function(a){if("string"!=typeof a)throw console.error("animation.play Invalid animation name argument",a),"";this.currentAnimation=this.animations[a],this.currentAnimation.currentFrame=this.currentAnimation.startFrame,console.log("animation.play",this.currentAnimation)},O.register("addon.animation",a)}(),function(){var a=function(){};a.prototype.classes=["stage.object"],a.prototype.attachBody=function(a){a.x=entity.position.x,a.y=entity.position.y,this.ctx.physics.attachBody(entity,a)
},O.register("addon.physics",a)}(),function(){var a=function(a,b){this.frames=[],this.renderer=this.ctx.renderer,this.currentFrame=null,this.stage=a,this.ctx=a.ctx;var c={x:0,y:0,anchor:{x:.5,y:.5}};this.settings=O.extend({},c,b),this.sprite=this.ctx.renderer.getSprite(),this.ctx.renderer.add(this.sprite),this.sprite.anchor.set(this.settings.anchor.x,this.settings.anchor.y),this.sprite.position.set(this.settings.x,this.settings.y),this.position=this.sprite.position,this.scale=this.sprite.scale,this.sprite.interactive=!0,this.sprite.buttonMode=!0};a.prototype.classes=["stage.object"],a.prototype.loadFrame=function(a,b){b=b||this.frames.length;var c=this.renderer.getTexture(a);return this.frames[b]=c,this.frameCurrent||this.setFrame(0),this},a.prototype.nextFrame=function(){this.setFrame(this.currentFrame+1)},a.prototype.setFrame=function(a){return 0===this.frames.length?this:(a>this.frames.length-1&&(a=0),0>a&&(a=this.frames.length-1),this.currentFrame=a,this.sprite.setTexture(this.frames[this.currentFrame]),this)},a.prototype.loadAnimation=function(a){var b=this.renderer.getAnimationTextures(a);console.log("sprite.loadAnimation",b.length);for(var c in b)this.frames.push(b[c]);return b},O.register("addon.sprite",a)}(),function(){function a(){return parseInt((new Date).getTime()).toString(16)}var b=function(b,c){this.stage=b,this.ctx=b.ctx;var d={id:a(),x:0,y:0,anchor:{x:.5,y:.5}};this.settings=O.extend({},d,c);var e=function(){this.update()}.bind(this),f=function(){this.ctx.off("update",e)}.bind(this);this.ctx.on("update",e),this.ctx.once("stop",f)};b.prototype.classes=["o.events"],b.prototype.update=function(){},b.prototype.getID=function(){return this.settings.id},O.register("stage.object",b)}(),function(){var a=function(a){this.stage=a.stage,this.stage.reset()};a.prototype.classes=["engine.component"],a.prototype.update=function(){},O.register("engine.state",a)}(Engine);